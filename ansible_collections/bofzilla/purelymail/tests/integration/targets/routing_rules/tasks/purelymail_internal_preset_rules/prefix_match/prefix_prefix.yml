---
- name: prefix_match | prefix_prefix | Create rules
  bofzilla.purelymail.routing_rules:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    inferred_safety: false
    rules:
      - domain_name: "{{ PURELYMAIL_DOMAIN }}"
        preset: prefix_match
        target_addresses: ["prefix@{{ PURELYMAIL_DOMAIN }}"]
        match_user: admin
      ## exact sames => API accepts but nothing happens
      ## same match_user => conflict
      ## same target_addresses => OK
      - domain_name: "{{ PURELYMAIL_DOMAIN }}"
        preset: prefix_match
        target_addresses: ["prefix@{{ PURELYMAIL_DOMAIN }}"]
        match_user: admin2
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"
  register: result

- name: prefix_match | prefix_prefix | Debug result
  ansible.builtin.debug:
    var: result

- name: prefix_match | prefix_prefix | Assert SUCCESS
  ansible.builtin.assert:
    that:
      - result is not failed
      - result.changed is true
      - result.rules | length == 2
