# Waiting for <https://github.com/ansible/ansible/pull/86074>
---
- name: missing_preset_or_settings |  Import integration_config.yml
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/integration_config.yml"

- name: missing_preset_or_settings | Routing rules management (should fail)
  bofzilla.purelymail.routing_rules:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"

    rules:
      - domain_name: toto
        target_addresses: []

  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"
  register: result
  ignore_errors: true

- name: missing_preset_or_settings | Debug result
  ansible.builtin.debug:
    var: result

- name: missing_preset_or_settings | Assert that the module failed and that the state is correct
  ansible.builtin.assert:
    that:
      - result.failed is true
      - '"rule[0]: preset is None but any of the following are missing: match_user, prefix, catchall found in rules" == result.msg'
