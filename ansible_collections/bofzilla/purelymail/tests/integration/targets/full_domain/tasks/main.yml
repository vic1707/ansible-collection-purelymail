# NOTE: ansible-test may warn "Unable to determine context" for multi-module tests.
#       This is expected and safe to ignore.
# TODO: I hate this
---
- name: Import integration_config.yml
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/integration_config.yml"

# ================================================================
# 1) VERIFY DOMAIN EXISTS INITIALLY
# ================================================================

- name: List domains (initial)
  bofzilla.purelymail.crud.domain.list_domains:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
  register: initial_list
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Ensure test domain exists initially
  ansible.builtin.assert:
    that:
      - PURELYMAIL_DOMAIN in (initial_list.domains | map(attribute='name') | list)

# ================================================================
# 2) UPDATE DOMAIN (should return changed=true)
# ================================================================

- name: Update domain settings
  bofzilla.purelymail.crud.domain.update_domain_settings:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    name: "{{ PURELYMAIL_DOMAIN }}"
    allow_account_reset: false # newly created domains have this enabled
  register: update_result
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert update changed state
  ansible.builtin.assert:
    that:
      - update_result is not failed
      - update_result.changed == true

# ================================================================
# 3) UPDATE IDEMPOTENCY (same settings → changed=false)
# ================================================================

- name: Update domain again (should be idempotent)
  bofzilla.purelymail.crud.domain.update_domain_settings:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    name: "{{ PURELYMAIL_DOMAIN }}"
    allow_account_reset: false
  register: update_again
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert update is idempotent
  ansible.builtin.assert:
    that:
      - update_again.changed == false

# ================================================================
# 4) UPDATE IDEMPOTENCY (same settings → changed=false)
# ================================================================

- name: Update domain by retriggering a dns check
  bofzilla.purelymail.crud.domain.update_domain_settings:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    name: "{{ PURELYMAIL_DOMAIN }}"
    recheck_dns: true
  register: update_again
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert update is idempotent
  ansible.builtin.assert:
    that:
      - update_again.changed == true

# ================================================================
# 5) DELETE DOMAIN (should return changed=true)
# ================================================================

- name: Delete test domain
  bofzilla.purelymail.crud.domain.delete_domain:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    domain_name: "{{ PURELYMAIL_DOMAIN }}"
  register: delete_result
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert delete changed state
  ansible.builtin.assert:
    that:
      - delete_result is not failed
      - delete_result.changed == true

# ================================================================
# 6) DELETE IDEMPOTENCY (should return changed=false)
# ================================================================

- name: Delete again (should be idempotent)
  bofzilla.purelymail.crud.domain.delete_domain:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    domain_name: "{{ PURELYMAIL_DOMAIN }}"
  register: delete_again
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert delete is idempotent
  ansible.builtin.assert:
    that:
      - delete_again.changed == false

# ================================================================
# 7) CREATE DOMAIN (should return changed=true)
# ================================================================

- name: Create test domain (restore state)
  bofzilla.purelymail.crud.domain.add_domain:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    domain_name: "{{ PURELYMAIL_DOMAIN }}"
  register: create_result
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert create changed state
  ansible.builtin.assert:
    that:
      - create_result is not failed
      - create_result.changed == true

# ================================================================
# 8) CREATE IDEMPOTENCY (should return changed=false)
# ================================================================

- name: Create again (should be idempotent)
  bofzilla.purelymail.crud.domain.add_domain:
    api_token: "{{ PURELYMAIL_API_TOKEN }}"
    domain_name: "{{ PURELYMAIL_DOMAIN }}"
  register: create_again
  environment:
    PURELYMAIL_API_TLS_VERIFY: "{{ PURELYMAIL_API_TLS_VERIFY }}"

- name: Assert create is idempotent
  ansible.builtin.assert:
    that:
      - create_again.changed == false
